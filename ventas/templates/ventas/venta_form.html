{% extends "base.html" %}
{% load static %}
{% load custom_select2 %}

{% block title %}{{ form.instance.pk|yesno:"Actualizar Venta,Crear Venta" }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ form.instance.pk|yesno:"Actualizar Venta,Crear Venta" }}</h1>
    <form method="post">
        {% csrf_token %}
        {{ form.media }}
        {{ form.as_p }}
        <h3>Pagos</h3>
        {{ pagos.management_form }}
        {% for form in pagos %}
            <div class="nested-form">
                {{ form.as_p }}
            </div>
        {% endfor %}
        <h3>Pedidos</h3>
        {{ pedidos.management_form }}
        {% for form in pedidos %}
            <div class="nested-form">
                {{ form.as_p }}
                <div class="form-group">
                    <label for="id_precio_unitario">Precio Unitario:</label>
                    <input type="text" name="precio_unitario" class="form-control" readonly />
                </div>
            </div>
        {% endfor %}
        <h3>Sesiones de Fotos</h3>
        {{ sesiones_fotos.management_form }}
        {% for form in sesiones_fotos %}
            <div class="nested-form">
                {{ form.as_p }}
                <div class="form-group">
                    <label for="id_precio_unitario">Precio Unitario:</label>
                    <input type="text" name="precio_unitario" class="form-control" readonly />
                </div>
            </div>
        {% endfor %}
        <button type="submit" class="btn btn-primary">Guardar</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
<script src="{% static 'django_select2/django_select2.js' %}"></script>
<script>
    $(document).ready(function() {
        $('.django-select2').djangoSelect2();

        function updatePriceUnitario(element) {
            const selectedOption = element.options[element.selectedIndex];
            const formGroup = element.closest('.nested-form') || element.closest('.form-group');
            const precioInput = formGroup.querySelector('input[name="precio_unitario"]');
            
            const productoId = selectedOption.value;
            if (productoId) {
                fetch(`/productos/api/productos/${productoId}/precio/`)
                    .then(response => response.json())
                    .then(data => {
                        if (precioInput && data.precio) {
                            precioInput.value = data.precio;
                        }
                    });
            }
        }

        function addListenersToFormsets() {
            const selects = document.querySelectorAll('select[name$="producto"]');
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    updatePriceUnitario(this);
                });

                const selectedOption = select.options[select.selectedIndex];
                if (selectedOption.value) {
                    updatePriceUnitario(select);
                }
            });
        }

        addListenersToFormsets();
        
        document.addEventListener('formset:added', function(event) {
            addListenersToFormsets();
        });
    });
</script>
{% endblock %}
