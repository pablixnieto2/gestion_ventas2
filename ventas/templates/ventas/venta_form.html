{% extends "base.html" %}
{% load static %}
{% load custom_select2 %}

{% block title %}{{ form.instance.pk|yesno:"Actualizar Venta,Crear Venta" }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ form.instance.pk|yesno:"Actualizar Venta,Crear Venta" }}</h1>
    <div class="row">
        <div class="col-md-8">
            <form method="post">
                {% csrf_token %}
                {{ form.media }}
                {{ form.as_p }}
                
                <h3>Productos de Venta</h3>
                {{ productos_venta.management_form }}
                {% for form in productos_venta %}
                    <div class="nested-form">
                        {{ form.as_p }}
                    </div>
                {% endfor %}
                
                <h3>Productos de Alquiler</h3>
                {{ productos_alquiler.management_form }}
                {% for form in productos_alquiler %}
                    <div class="nested-form">
                        {{ form.as_p }}
                    </div>
                {% endfor %}
                
                <h3>Pedidos</h3>
                {{ pedidos.management_form }}
                {% for form in pedidos %}
                    <div class="nested-form">
                        {{ form.as_p }}
                    </div>
                {% endfor %}
                
                <h3>Sesiones de Fotos</h3>
                {{ sesiones_fotos.management_form }}
                {% for form in sesiones_fotos %}
                    <div class="nested-form">
                        {{ form.as_p }}
                    </div>
                {% endfor %}
                
                <h3>Pagos</h3>
                {{ pagos.management_form }}
                {% for form in pagos %}
                    <div class="nested-form">
                        {{ form.as_p }}
                    </div>
                {% endfor %}
                
                <button type="submit" class="btn btn-primary">Guardar</button>
            </form>
        </div>
        <div class="col-md-4">
            <div id="resumen-lateral" class="sticky-top">
                <h3>Resumen</h3>
                <p>Total a pagar: <span id="total-a-pagar">0.00</span></p>
                <h4>Desglose:</h4>
                <ul id="detalle-productos"></ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
<script src="{% static 'django_select2/django_select2.js' %}"></script>
<script>
    $(document).ready(function() {
        $('.django-select2').djangoSelect2();

        function updatePriceUnitario(element) {
            const selectedOptions = Array.from(element.selectedOptions);
            const formGroup = element.closest('.nested-form') || element.closest('.form-group');
            const precioInput = formGroup.querySelector('input[name="precio_unitario"]');
            const detalleProductos = document.getElementById('detalle-productos');
            const isMultiple = element.multiple;
            let total = 0.00;

            if (isMultiple) {
                detalleProductos.innerHTML = '';
                selectedOptions.forEach(option => {
                    const productoId = option.value;
                    if (productoId) {
                        fetch(`/productos/api/productos/${productoId}/precio/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.precio) {
                                    total += parseFloat(data.precio);
                                    const li = document.createElement('li');
                                    li.innerText = `${option.text}: ${data.precio}`;
                                    detalleProductos.appendChild(li);
                                    document.getElementById('total-a-pagar').innerText = total.toFixed(2);
                                }
                            });
                    }
                });
            } else {
                const selectedOption = element.options[element.selectedIndex];
                const productoId = selectedOption.value;
                if (productoId) {
                    fetch(`/productos/api/productos/${productoId}/precio/`)
                        .then(response => response.json())
                        .then(data => {
                            if (precioInput && data.precio) {
                                precioInput.value = data.precio;
                                calculateTotal();
                            }
                        });
                }
            }
        }

        function calculateTotal() {
            let total = 0.00;
            document.querySelectorAll('input[name="precio_unitario"]').forEach(input => {
                const price = parseFloat(input.value) || 0.00;
                total += price;
            });
            document.getElementById('total-a-pagar').innerText = total.toFixed(2);
        }

        function addListenersToFormsets() {
            const selects = document.querySelectorAll('select[name$="producto"]');
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    updatePriceUnitario(this);
                });

                const selectedOptions = Array.from(select.selectedOptions);
                if (selectedOptions.length > 0) {
                    updatePriceUnitario(select);
                }
            });
        }

        addListenersToFormsets();
        
        document.addEventListener('formset:added', function(event) {
            addListenersToFormsets();
        });

        calculateTotal();
    });
</script>
{% endblock %}
