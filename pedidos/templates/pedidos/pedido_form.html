{% extends "base.html" %}
{% load static %}

{% block title %}Crear Pedido{% endblock %}

{% block content %}
<div class="container">
    <h1>Crear Pedido</h1>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <h2>Productos</h2>
        {{ productos.management_form }}
        {% for form in productos %}
            <div class="form-group">
                {{ form.as_p }}
            </div>
        {% endfor %}
        <button type="submit" class="btn btn-primary">Guardar</button>
        <a href="{% url 'pedidos:pedido-list' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function updatePriceUnitario(element) {
        const selectedOption = element.options[element.selectedIndex];
        const formGroup = element.closest('.form-group');
        const precioInput = formGroup.querySelector('input[name$="-precio_unitario"]');
        
        const productoId = selectedOption.value;
        if (productoId) {
            fetch(`/productos/api/productos/${productoId}/precio/`)
                .then(response => response.json())
                .then(data => {
                    if (precioInput && data.precio) {
                        precioInput.value = data.precio;
                    }
                });
        }
    }

    const selects = document.querySelectorAll('select[name$="-producto"]');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            updatePriceUnitario(this);
        });
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption.value) {
            updatePriceUnitario(select);
        }
    });
});
</script>
{% endblock %}
